<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        body,html {
            width: 100%;
            height: 100%;
        }
        div {
            width: 80%;
            margin: 0 auto;
            text-align: center;
        }
        h3 {
            margin: 20px auto;
        }
        footer {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 50px;
            line-height: 50px;
            text-align: center;
        }
        li {
            list-style: none;
        }
        li>span {
            display: inline-block;
            width: 150px;
            text-align: right;
        }
        li>input {
            margin-left: 0;
        }
        li#tip {
            font-size: 12px;
            color: red;
            margin-top: 10px;
            margin-left: 155px;
        }
    </style>
</head>
<body>
    <div id="box1">
        <h3>米话呼叫中心账号密码设置</h3>
        <ul>
            <li><span>登陆名：</span>xxxx</li>
            <li><span>请设置登陆密码：</span> <input type="password" id="setInp"></li>
            <li><span>请确认登陆密码：</span> <input type="password" id="confirmInp"></li>
            <li id="tip"></li>
        </ul>
        <button id="btn">完成设置</button>
    </div>
    <div id="box2" style="display:none">
        <h3>设置完成</h3>
        <button id='loginBtn'>点此立即登陆</button>
    </div>
    <div id="box3" style="display:none">
        <h2>链接失效，请通知管理员重新发送链接</h2>
    </div>
    <footer>Copyright @ 2018 EMI.All rights reserved  南京易米云通网络科技有限公司    版权所有苏ICP备14035390号-3</footer>
</body>
<script src="https://cdn.bootcss.com/crypto-js/3.1.9-1/crypto-js.js"></script>
<script>
    var box1 = document.querySelector('#box1')
    var box2 = document.querySelector('#box2')
    var box3 = document.querySelector('#box3')
    var btn = document.querySelector('#btn')
    var loginBtn = document.querySelector('#loginBtn')
    var setInp = document.querySelector('#setInp')
    var confirmInp = document.querySelector('#confirmInp')
    var liTip = document.querySelector('#tip')

    var query = location.href.split('?')[1]
    var params = getQuery(query)

    // 链接失效
    if(Date.now() - params.sendTime > 24 * 60 * 60 * 1000) {
        box1.style.display = "none"
        box3.style.display = "block"
    }

    setInp.onblur = function() {
        regTest()
    }

    setInp.onfocus = function() {
        liTip.innerText = ''
    }

    confirmInp.onblur = function() {
        if(!this.value.replace(/ /,'').length) return
        if(!setInp.value.replace(/ /,'').length) {
            liTip.innerText = '请设置登陆密码'
            return
        }
        if(this.value.replace(/ /,'') !== setInp.value) {
            liTip.innerText = '两次密码不同，请重新输入'
            return
        }
    }

    confirmInp.onfocus = function() {
        // liTip.innerText = ''
    }

    btn.onclick = function() {
        if(!setInp.value.replace(/ /,'').length) {
            liTip.innerText = '请设置登陆密码'
            return
        }
        if(!confirmInp.value.replace(/ /,'').length) {
            liTip.innerText = '请确认登陆密码'
            return
        }
        regTest()
        // 这儿需要调用 修改密码 的接口
        // 如果不调，就需要在自动填入账号密码之前调用
        box1.style.display = "none"
        box2.style.display = "block"
    }


    loginBtn.onclick = function() {
        // 跳转链接
        // http://127.0.0.1:8081?loginUrl=http://0.0.0.0:8080&userName=guanlulu&sendTime=1546499666814&operateType=init'
        var url = params.loginUrl
        var account = params.userName
        var password = confirmInp.value
        // 此处的 query => skip,是用来自动填入账号密码的 
        // 或者使用别的的query  ?account=guanlulu&password=123456
        // 是否需要加密
        location.href = `${url}#/login?account=${account}&password=${password}`
    }

    console.log(location.href.split('?')[1])

    if(params.operateType == 'reset') {
        loginBtn.style.display = 'none'
    }

    function regTest() {
        if(!setInp.value.replace(/ /,'').length) {
            liTip.innerText = '密码不能为空，密码为6~22位数字和字母的结合'
            return
        }
        var reg = /^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z]{6,22}$/
        if(!reg.test(setInp.value)) {
            console.log('dsf')
            liTip.innerText = '密码为6~22位数字和字母的结合'
            return
        }
        if(confirmInp.value.replace(/ /,'').length) {
            if(setInp.value !== confirmInp.value.replace(/ /,'')) {
                liTip.innerText = '两次密码不同，请重新输入'  
            }
        }
    }

    function getQuery(query) {
        // account=2333&password=dddfdf
        var obj = {}
        var arr = query.split('&')
        
        for(k of arr) {
            obj[k.split('=')[0]] = k.split('=')[1]
        }
        return obj
    }

    function encrypt(str) {
        // 密钥 16 位
        var key = '0123456789abcdef';
        // 初始向量 initial vector 16 位
        var iv = '0123456789abcdef';
        // key 和 iv 可以一致
        
        key = CryptoJS.enc.Utf8.parse(key);
        iv = CryptoJS.enc.Utf8.parse(iv);

        // mode 支持 CBC、CFB、CTR、ECB、OFB, 默认 CBC
        // padding 支持 Pkcs7、AnsiX923、Iso10126
        // 、NoPadding、ZeroPadding, 默认 Pkcs7, 即 Pkcs5
        
        // 加密
        var encrypted = CryptoJS.AES.encrypt(str, key, {
            iv: iv,
            mode: CryptoJS.mode.CTR,
            padding: CryptoJS.pad.Pkcs7
        });
        // 解密
        var decrypted = CryptoJS.AES.decrypt(encrypted, key, {
            iv: iv,
            mode: CryptoJS.mode.CTR,
            padding: CryptoJS.pad.Pkcs7
        });
        decrypted = CryptoJS.enc.Utf8.stringify(decrypted);
        console.log(decrypted)
        
        // 转换为字符串
        console.log(encrypted)
        encrypted = encrypted.toString();

        return encrypted
    }

</script>
</html>